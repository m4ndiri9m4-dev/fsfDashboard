<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>FSF Dashboard | Live Data Monitor</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" xintegrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Google Fonts for Futuristic Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons (Replaces missing img/*) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js Library for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Custom CSS (Merged from styles.css) -->
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #4F46E5, #EC4899); /* Indigo to Pink */
            color: white;
            min-height: 100vh;
            padding-top: 70px; /* Space for fixed navbar */
        }
        .gold-accent {
            color: #FFD700 !important; /* Gold accent color */
        }
        .futuristic-card {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            padding: 20px;
        }
        .navbar-dark {
            background-color: rgba(0, 0, 0, 0.8) !important;
            border-bottom: 2px solid #FFD700;
        }
        .navbar-brand, .nav-link {
            font-weight: 700;
        }
        .nav-link i {
            margin-right: 5px;
        }
        .custom-report h2 {
            color: #EC4899;
            font-weight: 700;
            font-size: 1.5rem;
        }
        .btn-warning {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #1a202c;
            transition: all 0.3s;
        }
        .btn-warning:hover {
            background-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            transform: scale(1.05);
        }
        /* Style for the fetched table data */
        .table-dark thead th {
            background-color: #4F46E5;
            color: #FFD700;
        }
        .table-dark tbody tr:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .table-dark tbody tr:hover {
            background-color: rgba(255, 215, 0, 0.1);
        }

        /* Home Grid Styles */
        .grid-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px 15px;
            height: 100%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: rgba(79, 70, 229, 0.6); /* Indigo base */
            border: 2px solid #FFD700;
            border-radius: 1rem;
        }
        .grid-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
            background-color: rgba(79, 70, 229, 0.8);
        }
        .grid-button i {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .grid-button span {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 5px #FFD700;
        }
        .chart-container {
            position: relative;
            height: 40vh; /* Set a default height for responsiveness */
            width: 100%;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 15px;
        }
        
        /* Calendar Styles */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #EC4899;
            color: white;
            padding: 10px;
            border-radius: 0.5rem 0.5rem 0 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 0 0 0.5rem 0.5rem;
            padding: 10px;
        }
        .day-name {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 5px 0;
            color: #FFD700; /* Gold accent */
        }
        .day-cell {
            padding: 10px 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .day-cell:hover {
            background-color: rgba(79, 70, 229, 0.8); /* Indigo hover */
        }
        .day-cell.inactive {
            color: rgba(255, 255, 255, 0.3);
            cursor: default;
        }
        .day-cell.inactive:hover {
            background-color: transparent;
        }
        .calendar-nav button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 10px;
        }

        /* Modal Styles */
        .modal-content {
            background: linear-gradient(135deg, #1f1d47, #3d0a25);
            border: 2px solid #EC4899;
            color: white;
            font-family: 'Orbitron', sans-serif;
        }
        .modal-header {
            border-bottom: 1px solid #FFD700;
        }
        .modal-title {
            color: #FFD700;
            font-weight: 700;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .attendance-cell {
            min-width: 50px;
            text-align: center;
            font-size: 0.85rem;
            padding: 5px;
        }
        .status-P { background-color: #38a169; } /* Green */
        .status-A { background-color: #c53030; } /* Red */
        .status-L { background-color: #4c51bf; } /* Blue/Late */
        .status-D { background-color: #dd6b20; } /* Orange/Day Off */

        /* Daily List Styles */
        .present-seller-list {
            list-style: none;
            padding: 0;
        }
        .present-seller-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* New style for Attendance List */
        .attendance-summary-list .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.05);
            border: none;
            margin-bottom: 5px;
            border-radius: 0.5rem;
            padding: 10px 15px;
        }
    </style>
</head>
<body>

    <!-- Start Navigation -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand gold-accent" href="#">FSF Dashboard by Elle</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Start Links -->
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <!-- Home -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchView('home')">
                            <i class="fas fa-home gold-accent"></i> Home
                        </a>
                    </li>
                    <!-- Mandays -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchView('mandays')">
                            <i class="fas fa-calendar-alt gold-accent"></i> Manpower Monitoring
                        </a>
                    </li>
                    <!-- Postpaid Monitoring -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchView('postpaid')">
                            <i class="fas fa-wifi gold-accent"></i> Postpaid
                        </a>
                    </li>
                    <!-- WowFi Pro Prepaid -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchView('wowfipro')">
                            <i class="fas fa-box-open gold-accent"></i> WowFi Pro
                        </a>
                    </li>
                    <!-- SIM Sold -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchView('simsold')">
                            <i class="fas fa-sim-card gold-accent"></i> SIM Sold
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- End Navigation -->

    <!-- Main Container -->
    <div class="container mt-5">
        <div id="content-area">

            <!-- ============================================== -->
            <!-- 0. HOME INTERFACE (Default View)               -->
            <!-- ============================================== -->
            <div id="home-view" class="view-section">
                <h1 class="text-center fw-bold mb-5 gold-accent">Dashboard Menu</h1>
                <div class="row g-4">
                    
                    <!-- Mandays Button -->
                    <div class="col-6 col-lg-3">
                        <div class="grid-button" onclick="switchView('mandays')">
                            <i class="fas fa-calendar-alt gold-accent"></i>
                            <span>Mandays</span>
                        </div>
                    </div>
                    
                    <!-- Postpaid Button -->
                    <div class="col-6 col-lg-3">
                        <div class="grid-button" onclick="switchView('postpaid')">
                            <i class="fas fa-wifi gold-accent"></i>
                            <span>Postpaid</span>
                        </div>
                    </div>

                    <!-- WowFi Pro Prepaid Button -->
                    <div class="col-6 col-lg-3">
                        <div class="grid-button" onclick="switchView('wowfipro')">
                            <i class="fas fa-box-open gold-accent"></i>
                            <span>WowFi Pro Prepaid</span>
                        </div>
                    </div>

                    <!-- SIM Sold Button -->
                    <div class="col-6 col-lg-3">
                        <div class="grid-button" onclick="switchView('simsold')">
                            <i class="fas fa-sim-card gold-accent"></i>
                            <span>SIM Sold</span>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- ============================================== -->
            <!-- 1. MANDAYS SECTION (NOW ATTENDANCE CALENDAR)   -->
            <!-- ============================================== -->
            <div id="mandays-view" class="view-section" style="display:none;">
                <h1 class="text-center fw-bold mb-5 gold-accent">Attendance Monitoring Calendar</h1>

                <!-- Combined Attendance Calendar View -->
                <div id="attendance-calendar-main" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>üìÖ Click a Date to View Attendance History</h2>
                        <!-- New button for Total Sellers Deployed -->
                        <button class="btn btn-sm btn-warning" onclick="fetchTotalSellersDeployed()">
                            <i class="fas fa-users me-1"></i> Total Manpower Days
                        </button>
                    </div>
                    <div id="seller-content" class="collapse mt-3 show">
                        <div class="text-center p-3 text-secondary">Loading Calendar...</div>
                    </div>
                </div>

                <!-- NEW: Attendance Per Seller List (Replaces Chart) -->
                <div id="attendance-seller-chart-summary" class="custom-report futuristic-card mb-4">
                    <h2>üìã Total Attendance Per Seller</h2>
                    <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#attendance-seller-chart-content" aria-expanded="false" aria-controls="attendance-seller-chart-content">
                        VIEW LIST DATA
                    </button>
                    <div id="attendance-seller-chart-content" class="collapse mt-3">
                        <!-- List will be rendered here by renderAttendanceListPerSeller -->
                        <div class="text-center p-3 text-secondary">Click 'View List Data' to load totals...</div>
                    </div>
                </div>
            </div>
            
            <!-- ============================================== -->
            <!-- 2. POSTPAID SECTION                            -->
            <!-- ============================================== -->
            <div id="postpaid-view" class="view-section" style="display:none;">
                 <h1 class="text-center fw-bold mb-5 gold-accent">Postpaid Monitoring</h1>
                 
                <!-- Applications Submitted -->
                <div id="postpaid-submitted-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications Submitted</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-submitted-content" aria-expanded="false" aria-controls="postpaid-submitted-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-submitted-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Submitted Applications Data...</div>
                    </div>
                </div>

                <!-- Applications Approved -->
                <div id="postpaid-approved-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications Approved</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-approved-content" aria-expanded="false" aria-controls="postpaid-approved-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-approved-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Approved Applications Data...</div>
                    </div>
                </div>
                
                <!-- Applications Denied -->
                <div id="postpaid-denied-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications Denied</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-denied-content" aria-expanded="false" aria-controls="postpaid-denied-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-denied-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Denied Applications Data...</div>
                    </div>
                </div>

                <!-- Applications Installed -->
                <div id="postpaid-installed-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications Installed</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-installed-content" aria-expanded="false" aria-controls="postpaid-installed-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-installed-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Installed Applications Data...</div>
                    </div>
                </div>

                <!-- Applications for Installation -->
                <div id="postpaid-forinstall-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications for Installation</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-forinstall-content" aria-expanded="false" aria-controls="postpaid-forinstall-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-forinstall-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Installation Queue Data...</div>
                    </div>
                </div>

                <!-- Applications for Approval (NEWLY ADDED AND CORRECTED BLOCK) -->
                <div id="postpaid-forapproval-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Applications for Approval</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#postpaid-forapproval-content" aria-expanded="false" aria-controls="postpaid-forapproval-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="postpaid-forapproval-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Approval Queue Data...</div>
                    </div>
                </div>

            </div>
            
            <!-- ============================================== -->
            <!-- 3. WOWFI PRO PREPAID SECTION                   -->
            <!-- ============================================== -->
            <div id="wowfipro-view" class="view-section" style="display:none;">
                <h1 class="text-center fw-bold mb-5 gold-accent">WowFi Pro Prepaid Monitoring</h1>
                
                <!-- No. of Sold -->
                <div id="wowfi-sold-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Sold</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#wowfi-sold-content" aria-expanded="false" aria-controls="wowfi-sold-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="wowfi-sold-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Sold Count Data...</div>
                    </div>
                </div>

                <!-- No. of Activated -->
                <div id="wowfi-activated-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Activated</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#wowfi-activated-content" aria-expanded="false" aria-controls="wowfi-activated-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="wowfi-activated-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Activated Count Data...</div>
                    </div>
                </div>

                <!-- Visual Chart Sold/Activated per Day -->
                <div id="wowfi-daily-chart-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Visual Chart for Sold/Activated per Day</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#wowfi-daily-chart-content" aria-expanded="false" aria-controls="wowfi-daily-chart-content">
                            VIEW CHART DATA
                        </button>
                    </div>
                    <div id="wowfi-daily-chart-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Seller Chart Data...</div>
                    </div>
                </div>

                <!-- Visual Chart Sold/Activated per Seller -->
                <div id="wowfi-seller-chart-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Visual Chart for Sold/Activated per Seller</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#wowfi-seller-chart-content" aria-expanded="false" aria-controls="wowfi-seller-chart-content">
                            VIEW CHART DATA
                        </button>
                    </div>
                    <div id="wowfi-seller-chart-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Seller Chart Data...</div>
                    </div>
                </div>

            </div>
            
            <!-- ============================================== -->
            <!-- 4. SIM SOLD SECTION                            -->
            <!-- ============================================== -->
            <div id="simsold-view" class="view-section" style="display:none;">
                <h1 class="text-center fw-bold mb-5 gold-accent">SIM Sold Monitoring</h1>
                
                <!-- No. of Sold -->
                <div id="simsold-sold-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Sold</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#simsold-sold-content" aria-expanded="false" aria-controls="simsold-sold-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="simsold-sold-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Sold Count Data...</div>
                    </div>
                </div>

                <!-- No. of Activated -->
                <div id="simsold-activated-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>No. of Activated</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#simsold-activated-content" aria-expanded="false" aria-controls="simsold-activated-content">
                            VIEW DATA
                        </button>
                    </div>
                    <div id="simsold-activated-content" class="collapse mt-3">
                        <div class="text-center p-3 text-secondary">Loading Activated Count Data...</div>
                    </div>
                </div>

                <!-- Visual Chart Sold per Day -->
                <div id="simsold-daily-chart-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Visual Chart for Sold per Day</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#simsold-daily-chart-content" aria-expanded="false" aria-controls="simsold-daily-chart-content">
                            VIEW CHART DATA
                        </button>
                    </div>
                    <!-- ADDED: Canvas element for the Daily Chart -->
                    <div id="simsold-daily-chart-content" class="collapse mt-3">
                        <div class="chart-container">
                            <canvas id="simSoldDailyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Visual Chart Total Sold per Seller -->
                <div id="simsold-seller-total-chart-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Visual Chart for Total Sold per Seller</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#simsold-seller-total-chart-content" aria-expanded="false" aria-controls="simsold-seller-total-chart-content">
                            VIEW CHART DATA
                        </button>
                    </div>
                    <!-- ADDED: Canvas element for the Seller Total Chart -->
                    <div id="simsold-seller-total-chart-content" class="collapse mt-3">
                        <div class="chart-container">
                            <canvas id="simSoldSellerTotalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Visual Chart Activated per Seller (Original Block) -->
                <div id="simsold-seller-chart-summary" class="custom-report futuristic-card mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Visual Chart for Activated per Seller</h2>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#simsold-seller-chart-content" aria-expanded="false" aria-controls="simsold-seller-chart-content">
                            VIEW CHART DATA
                        </button>
                    </div>
                    <!-- ADDED: Canvas element for the Seller Chart -->
                    <div id="simsold-seller-chart-content" class="collapse mt-3">
                        <div class="chart-container">
                            <canvas id="simSoldSellerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Main Container -->

    <!-- Attendance Details Modal -->
    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceModalLabel">Attendance for [Date]</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Dynamic attendance list will be inserted here -->
                    <div id="attendanceDetailsBody">Loading details...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal -->

    <footer class="py-3 mt-auto bg-dark">
        <div class="container">
            <!-- Main IP Statement Paragraph -->
            <p class="m-0 text-center text-white-50" style="color: red !important;">
All content, data visualizations, reports, and design elements presented on this website and in associated documents are the intellectual property of Gracelle Anne Magnaye, CCMGI Project Coordinator. These materials are protected under applicable copyright and intellectual property laws.
Unauthorized reproduction, distribution, modification, or commercial use of any part of these reports‚Äîwhether in whole or in part‚Äîis strictly prohibited without prior written consent. This includes, but is not limited to, copying data structures, UI/UX layouts, dashboard components, and embedded analytics.
Use of these materials by clients and stakeholders is permitted solely for internal review and decision-making purposes. Any external sharing or publication must be explicitly approved.
            </p>
            <!-- Separate Copyright Line, now in red and bold -->
            <p class="m-0 text-center fw-bold" style="color: red !important;">
                ¬© 2025 Gracelle Anne Magnaye, CCMGI. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <script>
        // Global map to hold Chart instances for dynamic destruction and recreation
        let chartInstances = {}; 
        let attendanceDataCache = null; // Cache for the seller attendance matrix
        let currentCalendarDate = new Date(); // Tracks the currently displayed month/year

        // !! SECURITY WARNING !!
        // Exposing your API Key in the frontend is highly insecure.
        // For a live application, it is best practice to use a Google Apps Script Web App
        // as a secure proxy to fetch data and protect your key.
        const API_KEY = 'AIzaSyCoastovR_u1wB8gxkAOn5Esy6OU22ozVY'; 
        const SPREADSHEET_ID = '10rPB-U5hdtdAkyfZlcmr82Fg_SnV1P8g5nwQ_D-0ABI'; // Your main Spreadsheet ID
        // UPDATED BASE_URL for the Google Visualization Query Language endpoint
        const QUERY_URL = 'https://docs.google.com/spreadsheets/d/';

        // =========================================================================
        // NEW: MULTI-SHEET ATTENDANCE CONFIGURATION (EDIT THIS OBJECT)
        // Map Month/Year (M/YYYY) to the correct Sheet Name and Range.
        // Format: 'MonthNumber/Year': { sheet: 'SheetName', range: 'A1:Z100' }
        // The sheet range MUST contain: [Seller First Name, Seller Last Name, Designation, Date 1, Date 2, ...]
        // =========================================================================
        const ATTENDANCE_CONFIG = {
            // FIX: Separated September into two distinct pay periods for multi-range fetching.
            '9/2025': [
                { sheet: 'September 1 to 15, 2025', range: 'A6:R18', endDay: 15 }, 
                { sheet: 'September 16 to 30, 2025', range: 'A6:R27', endDay: 30 } 
            ],
            '10/2025': [
                { sheet: 'October 1 to 15, 2025', range: 'C3:AI17', endDay: 15 },
                { sheet: 'October 16 to 31, 2025', range: 'C3:AI17', endDay: 31 }
            ]
        };

        /**
         * Looks up the correct sheet and range for the given date.
         * This function now handles multi-range periods within a single month.
         * @param {Date} date - The date to check.
         * @returns {{range: string, sheet: string, periods: Array} | null} 
         */
        function getAttendanceRange(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            const key = `${month}/${year}`;
            
            const periods = ATTENDANCE_CONFIG[key];
            
            if (periods) {
                // Check for the special 'Total Manpower Days' call where day is 0 (handled by fetchTotalSellersDeployed)
                if (day === 0) { 
                    // Return the entire periods array for fetching all sheets in the month (for totals/charts)
                    return { periods: periods, sheet: 'Combined Month', range: 'N/A' };
                }

                // FIX: Added logic to handle dates falling exactly on the endDay correctly
                const config = periods.find(p => day <= p.endDay);
                
                if (config) {
                    // Returns the A1 notation with the sheet name correctly prefixed
                    return { 
                        range: `${config.sheet}!${config.range}`,
                        sheet: config.sheet // Used internally, now hidden from title
                    };
                }
            }
            return null;
        }
        
        /**
         * Fetches data from Google Sheets and renders it as an HTML table.
         * ... (fetchAndRender function remains the same) ...
         */
        async function fetchAndRender(spreadsheetId, range, targetId, customHeaders = null) {
            const targetElement = document.getElementById(targetId);
            // Use the original Sheets API for raw table data
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
            
            // Show loading state
            targetElement.innerHTML = '<div class="text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin gold-accent me-2"></i> Loading data from Google Sheets...</div>';

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();

                if (!data.values || data.values.length === 0) {
                    targetElement.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è No data found for the specified range.</div>';
                    return;
                }

                const rows = data.values;
                let html = '<div class="table-responsive"><table class="table table-dark table-bordered"><thead><tr>';
                
                // Determine headers and data rows
                let headers = [];
                let dataRows = [];

                if (customHeaders && customHeaders.length > 0) {
                    // Use custom headers and treat all fetched rows as data
                    headers = customHeaders;
                    dataRows = rows;
                } else {
                    // Use the first fetched row as header and the rest as data
                    headers = rows[0];
                    dataRows = rows.slice(1);
                }
                
                // Render headers
                headers.forEach(header => html += `<th scope="col">${header}</th>`);
                html += '</tr></thead><tbody>';

                // Render data rows
                dataRows.forEach(row => {
                    html += '<tr>';
                    // Ensure row has enough cells to match header length for consistent columns
                    const headerCount = headers.length; // Use the derived headers length
                    for (let i = 0; i < headerCount; i++) {
                        const cell = row[i] !== undefined ? row[i] : '';
                        html += `<td>${cell}</td>`;
                    }
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                targetElement.innerHTML = html;

            } catch (error) {
                targetElement.innerHTML = `<div class="alert alert-danger">‚ùå Failed to load data. Error: ${error.message}</div>`;
                console.error(`Error loading ${range} from ${spreadsheetId}:`, error);
            }
        }
        
        // =========================================================================
        // NEW FUNCTION: RENDER ATTENDANCE LIST PER SELLER (Replaces Chart logic)
        // =========================================================================
        async function renderAttendanceListPerSeller(targetId) {
            const date = currentCalendarDate;
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            const key = `${month}/${year}`;
            const targetElement = document.getElementById(targetId);

            const periods = ATTENDANCE_CONFIG[key];
            
            if (!periods) {
                targetElement.innerHTML = `<div class="alert alert-danger">‚ùå Configuration Error: No sheet periods defined for ${month}/${year}. Please check **ATTENDANCE_CONFIG**.</div>`;
                return;
            }

            targetElement.innerHTML = '<div class="text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin gold-accent me-2"></i> Calculating total attendance per seller...</div>';

            try {
                let sellerTotalsMap = {};
                
                // 1. Loop through all periods (sheets) for the current month
                for (const period of periods) {
                    const periodRange = `${period.sheet}!${period.range}`;
                    const periodUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(periodRange)}?key=${API_KEY}`;
                    
                    const response = await fetch(periodUrl);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`[${period.sheet}] HTTP error: ${errorData.message || response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.values || data.values.length < 2) {
                        console.warn(`Warning: No seller data found for sheet ${period.sheet}`);
                        continue;
                    }

                    const [headerRow, ...sellerRows] = data.values;
                    const dateColumnsStartIndex = 3; 
                    const dataColumnsEndIndex = headerRow.length; 
                    
                    // 2. Aggregate attendance counts per seller
                    sellerRows.forEach(row => {
                        const fullName = `${row[0] || ''} ${row[1] || ''}`.trim();
                        if (!fullName) return; 

                        let totalCount = 0;
                        
                        for (let i = dateColumnsStartIndex; i < dataColumnsEndIndex; i++) {
                            const rawValue = (row[i] || '').trim().toUpperCase();
                            if (rawValue.includes('PRESENT') || rawValue === 'P') {
                                totalCount++;
                            }
                        }
                        
                        // Aggregate totals for the seller
                        // FIX: Store seller totals as an object { total: T, period1: P1, period2: P2 }
                        if (!sellerTotalsMap[fullName]) {
                             sellerTotalsMap[fullName] = { 
                                total: 0, 
                                attendance: {} 
                            };
                        }
                        sellerTotalsMap[fullName].total += totalCount;
                        sellerTotalsMap[fullName].attendance[period.sheet] = totalCount;
                    });
                }
                
                // 3. Prepare data for list and sort by total days (highest first)
                let finalSellerList = Object.entries(sellerTotalsMap)
                    .map(([name, data]) => ({ name, totalDays: data.total, attendance: data.attendance }))
                    .sort((a, b) => b.totalDays - a.totalDays);

                if (finalSellerList.length === 0) {
                    targetElement.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è No attendance data found for this period.</div>';
                    return;
                }

                // 4. Render the list
                let listHtml = '<ul class="list-group attendance-summary-list">';
                finalSellerList.forEach(seller => {
                    const period1Days = seller.attendance[periods[0].sheet] || 0;
                    const period2Days = (periods.length > 1 ? seller.attendance[periods[1].sheet] : 0) || 0;

                    // Dynamically generate the details for the two periods
                    // FIX: Applying gold and silver colors to the period labels
                    let periodDetailsHtml = `<span class="fw-bold me-3" style="color: #FFD700;">P1: ${period1Days} Mandays</span>`; // Gold
                    if (periods.length > 1) {
                         periodDetailsHtml += `<span class="fw-bold" style="color: #C0C0C0;">P2: ${period2Days} Mandays</span>`; // Silver
                    }
                    
                    listHtml += `
                        <li class="list-group-item">
                            <div class="d-flex flex-column align-items-start">
                                <span class="fw-bold text-white">${seller.name}</span>
                                <div class="text-xs mt-1">${periodDetailsHtml}</div>
                            </div>
                            <span class="badge bg-success p-2 fs-6">${seller.totalDays} Total Mandays</span>
                        </li>
                    `;
                });
                listHtml += '</ul>';

                targetElement.innerHTML = listHtml;

            } catch (error) {
                targetElement.innerHTML = `<div class="alert alert-danger">‚ùå Failed to load list. Error: ${error.message}</div>`;
                console.error(`Error calculating total attendance per seller:`, error);
            }
        }
        // =========================================================================

        
        /**
         * Fetches data for charting and renders a Chart.js visualization.
         * ... (fetchAndRenderChart function remains the same) ...
         */
        async function fetchAndRenderChart(spreadsheetId, range, canvasId, config) {
            const chartElement = document.getElementById(canvasId);
            const parentElement = chartElement.closest('.collapse');
            
            // This URL is NOT used for multi-period charts (attendance_total_per_seller) but kept for other modes.
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
            
            // Clear previous chart and show loading state
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
                delete chartInstances[canvasId];
            }
            // Add a temporary loading indicator before fetching
            parentElement.innerHTML = '<div class="chart-container text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin gold-accent me-2"></i> Loading chart data...</div>';

            try {
                let labels = [];
                let values = [];
                let isMultiPeriodChart = config.processingMode === 'attendance_total_per_seller';

                if (isMultiPeriodChart) {
                    // FIX: This section now calls the list renderer instead of charting logic, 
                    //      but since the listener is removed, this block is technically dead code. 
                    //      The actual list logic is moved to renderAttendanceListPerSeller.
                    parentElement.innerHTML = '<div class="alert alert-danger">Error: Chart logic unexpectedly called.</div>';
                    return;

                } else if (config.processingMode === 'daily_total') {
                    // --- MODE 1: DAILY TOTAL (Column Sums) ---
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!data.values || data.values.length < 2) throw new Error("Insufficient data for single period chart.");

                    labels = data.values[0].slice(3).filter(label => label.trim() !== '');
                    const numDays = labels.length;
                    const dailyTotals = new Array(numDays).fill(0);
                    
                    for (let j = 1; j < data.values.length; j++) {
                        for (let i = 0; i < numDays; i++) {
                            const saleValue = parseFloat(data.values[j][i + 3]) || 0;
                            dailyTotals[i] += saleValue;
                        }
                    }
                    values = dailyTotals;

                } else if (config.processingMode === 'seller_total') {
                    // --- MODE 2: SELLER TOTAL (Row Sums - Simple) ---
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!data.values || data.values.length < 2) throw new Error("Insufficient data for single period chart.");
                    
                    let sellerTotalsMap = {};
                    
                    for (let j = 1; j < data.values.length; j++) {
                        const row = data.values[j];
                        const fullName = `${row[0] || ''} ${row[1] || ''}`.trim();
                        if (!fullName) continue; 

                        let totalCount = 0;
                        for (let i = 3; i < row.length; i++) {
                            const saleValue = parseFloat(row[i]) || 0;
                            totalCount += saleValue;
                        }
                        sellerTotalsMap[fullName] = (sellerTotalsMap[fullName] || 0) + totalCount;
                    }
                    labels = Object.keys(sellerTotalsMap);
                    values = Object.values(sellerTotalsMap);

                } else {
                    // --- Default Simple Column Pull (Labels Col 1, Values Col 2) ---
                     const response = await fetch(url);
                    const data = await response.json();
                    labels = data.values.slice(1).map(row => row[0] || 'N/A');
                    values = data.values.slice(1).map(row => parseFloat(row[1]) || 0);
                }
                
                if (values.length === 0 || values.every(val => val === 0)) {
                    parentElement.innerHTML = '<div class="chart-container alert alert-warning">‚ö†Ô∏è Chart data calculation failed or all values are zero.</div>';
                    return;
                }

                // Restore canvas element for Chart.js
                parentElement.innerHTML = `<div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                chartInstances[canvasId] = new Chart(ctx, {
                    type: config.chartType, // 'bar' or 'line'
                    data: {
                        labels: labels, 
                        datasets: [{
                            label: config.dataLabel,
                            data: values, 
                            backgroundColor: config.chartType === 'bar' ? 'rgba(255, 215, 0, 0.7)' : 'rgba(79, 70, 229, 0.7)', 
                            borderColor: config.chartType === 'bar' ? '#FFD700' : '#4F46E5',
                            borderWidth: 2,
                            // Use fill for line charts, borderRadius for bar charts
                            fill: config.chartType === 'line' ? true : false,
                            tension: 0.4,
                            borderRadius: config.chartType === 'bar' ? 5 : 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                labels: { 
                                    color: '#FFD700', 
                                    font: { family: 'Orbitron' } 
                                } 
                            },
                            title: {
                                display: true,
                                text: config.chartTitle,
                                color: '#EC4899',
                                font: { family: 'Orbitron', size: 18 }
                            },
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { color: 'white', font: { family: 'Orbitron' } },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                            },
                            x: { 
                                ticks: { color: 'white', font: { family: 'Orbitron' } },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                            }
                        }
                    }
                });

            } catch (error) {
                parentElement.innerHTML = `<div class="chart-container alert alert-danger">‚ùå Failed to render chart. Error: ${error.message}</div>`;
                console.error(`Error loading chart data from range:`, error);
            }
        }
        
        /**
         * Fetches and displays the Total Sellers Deployed (Total Unique Present Sellers) for the month.
         */
        async function fetchTotalSellersDeployed() {
            const date = currentCalendarDate;
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            const key = `${month}/${year}`;
            
            // Directly check ATTENDANCE_CONFIG for the month key
            const periods = ATTENDANCE_CONFIG[key];
            
            if (!periods) {
                const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = `‚ùå **Configuration Error:** No sheet periods defined for ${monthYear}. Please check **ATTENDANCE_CONFIG**.`;
                
                const totalSellersDeployedModal = new bootstrap.Modal(document.getElementById('attendanceModal'));
                const modalTitle = document.getElementById('attendanceModalLabel');
                const modalBody = document.getElementById('attendanceDetailsBody');
                modalTitle.textContent = `Error Loading Totals`;
                modalBody.innerHTML = ''; // Clear loading spinner
                modalBody.appendChild(errorDiv);
                totalSellersDeployedModal.show();
                return;
            }
            
            const totalSellersDeployedModal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            const modalBody = document.getElementById('attendanceDetailsBody');
            const modalTitle = document.getElementById('attendanceModalLabel');

            modalTitle.textContent = `Total Attendance (Manpower Days) - ${date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            modalBody.innerHTML = '<div class="text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin gold-accent me-2"></i> Calculating total present days...</div>';
            totalSellersDeployedModal.show();

            try {
                let totalTLAttendance = 0;
                let totalSellerAttendance = 0;
                
                // NEW: Period specific totals
                let tlAttendancePeriod1 = 0;
                let sellerAttendancePeriod1 = 0;
                let tlAttendancePeriod2 = 0;
                let sellerAttendancePeriod2 = 0;
                
                // Track unique TLs and Sellers found in the combined period to get a count of manpower slots
                let uniqueTLs = new Set();
                let uniqueSellers = new Set();
                
                // --- Deployment Targets (Hardcoded as requested) ---
                const TL_DAILY_TARGET = 1;
                const SELLER_DAILY_TARGET = 8;
                let actualWorkingDays = 0; // Number of days in the month that are part of P1 or P2

                // Define hardcoded rest days/holidays for September 2025
                const yearToCheck = 2025;
                const monthToCheck = 8; // September is month 8 (0-indexed)
                // September 7, 8, 9 are holidays
                const holidays = [
                    new Date(yearToCheck, monthToCheck, 7).getTime(),
                    new Date(yearToCheck, monthToCheck, 8).getTime(),
                    new Date(yearToCheck, monthToCheck, 9).getTime(),
                ];
                
                // 1. Calculate Total Possible Working Days in the Month
                const daysInMonth = new Date(yearToCheck, monthToCheck + 1, 0).getDate();
                let totalPossibleWorkingDays = 0;

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(yearToCheck, monthToCheck, day);
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                    const dayTime = date.getTime();

                    // Exclude Sunday (dayOfWeek === 0)
                    if (dayOfWeek === 0) continue; 

                    // Exclude specified holidays
                    if (holidays.includes(dayTime)) continue; 

                    totalPossibleWorkingDays++;
                }
                
                actualWorkingDays = totalPossibleWorkingDays;
                
                // Fetch and process data for ALL periods defined in the current month
                for (let pIndex = 0; pIndex < periods.length; pIndex++) {
                    const period = periods[pIndex];
                    const range = `${period.sheet}!${period.range}`;
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`[${period.sheet}] HTTP error: ${errorData.message || response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.values || data.values.length < 2) {
                        console.warn(`Warning: No seller data found for sheet ${period.sheet}`);
                        continue;
                    }

                    const [headerRow, ...sellerRows] = data.values;
                    // The Designation column is at index 2 (A=0, B=1, C=2) based on your range 'A6:R...'
                    const designationColumnIndex = 2; 
                    const dateColumnsStartIndex = 3; 
                    const dateHeaders = headerRow.slice(dateColumnsStartIndex).filter(h => h.trim() !== '');
                    const dataColumnsEndIndex = dateColumnsStartIndex + dateHeaders.length;
                    
                    
                    // Iterate through each seller row
                    sellerRows.forEach(row => {
                        const fullName = `${row[0] || ''} ${row[1] || ''}`.trim();
                        const designation = (row[designationColumnIndex] || '').trim().toUpperCase();
                        
                        if (!fullName) return; // Skip empty rows

                        // Determine the role for unique count tracking
                        const isTL = designation.includes('TEAM LEADER') || designation.includes('TL');
                        const isSeller = designation.includes('SELLER');
                        
                        if (isTL) uniqueTLs.add(fullName);
                        if (isSeller) uniqueSellers.add(fullName);
                        
                        // Check attendance across all date columns (starting from index 3)
                        for (let i = dateColumnsStartIndex; i < dataColumnsEndIndex; i++) {
                            const rawStatus = (row[i] || '').trim().toUpperCase();
                            const isPresent = rawStatus.includes('PRESENT') || rawStatus === 'P';
                            
                            if (isPresent) {
                                if (isTL) {
                                    totalTLAttendance++;
                                    // Store period-specific total
                                    if (pIndex === 0) tlAttendancePeriod1++;
                                    if (pIndex === 1) tlAttendancePeriod2++;

                                } else if (isSeller) {
                                    totalSellerAttendance++;
                                    // Store period-specific total
                                    if (pIndex === 0) sellerAttendancePeriod1++;
                                    if (pIndex === 1) sellerAttendancePeriod2++;
                                }
                            }
                        }
                    });
                }
                
                const totalManpowerDays = totalTLAttendance + totalSellerAttendance;
                
                // --- 2. Calculate Actual Deployment Targets based on requested formula ---
                
                // Total POSSIBLE TL Mandays (Target 1 TL x Actual Working Mandays)
                const tlTargetDeployment = actualWorkingDays * TL_DAILY_TARGET; 
                
                // Total TARGET Seller Mandays (Target 8 x Actual Working Mandays)
                const sellerTargetDeployment = actualWorkingDays * SELLER_DAILY_TARGET; 
                
                // --- 3. Calculate Deployment Percentage ---
                // TL Deployment %: (Total TL Attendance / Target TL Days) * 100
                const tlDeploymentPercent = tlTargetDeployment > 0 ? (totalTLAttendance / tlTargetDeployment) * 100 : 0;
                
                // Seller Deployment %: (Total Seller Attendance / Total Target Seller Mandays) * 100
                // FIX: Using the Target Denominator of 184 as specified by the user's manual calculation, 
                //      while the numerator is the dynamic attendance.
                const FIXED_SELLER_TARGET_MANDAYS = 184; // Fixed Target from user's request (145/184)
                
                const sellerDeploymentPercent = FIXED_SELLER_TARGET_MANDAYS > 0 ? (totalSellerAttendance / FIXED_SELLER_TARGET_MANDAYS) * 100 : 0;


                // Retrieve period names safely
                const period1Name = periods[0] ? periods[0].sheet : 'P1 (Missing)';
                const period2Name = periods[1] ? periods[1].sheet : 'P2 (Missing)';

                modalBody.innerHTML = `
                    <div class="text-center p-5">
                        <h1 class="gold-accent display-4 fw-bold">${totalManpowerDays}</h1>
                        <p class="text-white-50 fs-5">Total **Mandays** (Present Mandays) deployed during this period.</p>
                        <hr class="border-secondary my-3">
                        
                        <h4 class="text-white fw-bold mb-3">Team Leader Totals (Target Mandays: ${tlTargetDeployment})</h4>
                        <p class="text-white fs-6 mb-1">
                            Present Mandays: <span class="fw-bold text-success">${totalTLAttendance} Mandays</span>
                        </p>
                        <p class="text-white fs-4 fw-bold mb-4">
                            Deployment %: <span class="gold-accent">${tlDeploymentPercent.toFixed(1)}%</span>
                        </p>

                        <h4 class="text-white fw-bold mb-3">Seller Totals (Target Mandays: ${FIXED_SELLER_TARGET_MANDAYS})</h4>
                        <p class="text-white fs-6 mb-1">
                            Present Mandays: <span class="fw-bold text-success">${totalSellerAttendance} Mandays</span>
                        </p>
                        <p class="text-white fs-4 fw-bold">
                            Deployment %: <span class="gold-accent">${sellerDeploymentPercent.toFixed(1)}%</span>
                        </p>
                        
                        <hr class="border-secondary my-3">

                        <h5 class="text-white fw-bold mb-3">Period Breakdown:</h5>
                        <div class="d-flex justify-content-around text-center">
                            <div class="text-sm">
                                <span class="fw-bold" style="color: #FFD700;">${period1Name}</span><br>
                                <span class="text-white-50">TL: ${tlAttendancePeriod1} | S: ${sellerAttendancePeriod1}</span>
                            </div>
                            <div class="text-sm">
                                <span class="fw-bold" style="color: #C0C0C0;">${period2Name}</span><br>
                                <span class="text-white-50">TL: ${tlAttendancePeriod2} | S: ${sellerAttendancePeriod2}</span>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                // Show the specific error in the modal, but remove the alert() wrapper
                modalBody.innerHTML = `<div class="alert alert-danger">‚ùå Failed to calculate total sellers. Error: ${error.message}</div>`;
                console.error('Error fetching total sellers deployed:', error);
            }
        }


        // --- NEW: CALENDAR FUNCTIONS ---

        /**
         * Renders a basic calendar structure for the current month and attaches click handlers.
         * @param {string} targetId - The ID of the container to render the calendar into.
         * @param {Date} date - The date object used to determine the current month/year.
         */
        async function renderAttendanceCalendar(targetId, date) {
            const container = document.getElementById(targetId);
            const year = date.getFullYear();
            const month = date.getMonth();
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 1 = Monday...
            
            const monthName = date.toLocaleString('default', { month: 'long' });
            
            // FIX: Get the range config here, but only to check if the month exists
            const configCheck = getAttendanceRange(date);
            const isConfigured = !!configCheck; 

            if (!isConfigured) {
                container.innerHTML = `<div class="alert alert-danger">‚ùå Error: No sheet configuration found for ${monthName} ${year}. Please check ATTENDANCE_CONFIG.</div>`;
                return;
            }

            let calendarHtml = `
                <div class="futuristic-card">
                    <div class="calendar-nav text-center mb-2">
                        <button onclick="changeCalendarMonth(-1)" title="Previous Month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <!-- FIX: Only display Month and Year -->
                        <span>${monthName} ${year}</span>
                        <button onclick="changeCalendarMonth(1)" title="Next Month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid">
                        <div class="day-name">Sun</div>
                        <div class="day-name">Mon</div>
                        <div class="day-name">Tue</div>
                        <div class="day-name">Wed</div>
                        <div class="day-name">Thu</div>
                        <div class="day-name">Fri</div>
                        <div class="day-name">Sat</div>
            `;

            // Add leading blank days
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarHtml += `<div class="day-cell inactive"></div>`;
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                // Formatting date string as M/D/YYYY to match spreadsheet header (e.g., 9/1/2025)
                const dateString = `${month + 1}/${day}/${year}`;
                
                // Attach the click handler to call fetchAndShowDailyAttendance
                calendarHtml += `<div class="day-cell" data-date="${dateString}" onclick="fetchAndShowDailyAttendance('${dateString}')">${day}</div>`;
            }

            calendarHtml += `</div></div>`;
            container.innerHTML = calendarHtml;
        }
        
        /**
         * Navigates the calendar view by changing the currentCalendarDate.
         * @param {number} offset - -1 for previous month, 1 for next month.
         */
        function changeCalendarMonth(offset) {
            // Clear cache because we are looking at a new sheet/range
            attendanceDataCache = null; 
            
            // Set the new date based on the current date + offset
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            
            // Re-render the calendar for the new month/year
            renderAttendanceCalendar('seller-content', currentCalendarDate);
        }

        /**
         * Fetches all necessary attendance data from the sheet (if not cached), 
         * extracts details for the clicked date, and displays the modal with full history.
         * * @param {string} dateString - The date clicked (e.g., "9/29/2025").
         */
        async function fetchAndShowDailyAttendance(dateString) {
            const modalBody = document.getElementById('attendanceDetailsBody');
            const modalTitle = document.getElementById('attendanceModalLabel');
            modalTitle.textContent = `Daily Attendance & History for ${dateString}`;
            modalBody.innerHTML = '<div class="text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin gold-accent me-2"></i> Fetching attendance details...</div>';
            
            const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            modal.show();

            const rangeConfig = getAttendanceRange(new Date(dateString));
            // The rangeConfig for a single date must NOT have the 'periods' property.
            if (!rangeConfig || rangeConfig.periods) { 
                 modalBody.innerHTML = `<div class="alert alert-danger">‚ùå Configuration Error: No single range defined for this date. Check ATTENDANCE_CONFIG.</div>`;
                 return;
            }
            const range = rangeConfig.range;


            try {
                let dataValues;
                
                // Cache logic check/fetch
                if (attendanceDataCache && attendanceDataCache.range === range) {
                     dataValues = attendanceDataCache.values;
                } else {
                    attendanceDataCache = null;
                    dataValues = await fetchDataMatrix(range);
                }
                
                // Helper to fetch and cache the data matrix
                async function fetchDataMatrix(currentRange) {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(currentRange)}?key=${API_KEY}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) {
                        throw new Error("Insufficient data for attendance matrix.");
                    }
                    // Store values and the range used in the cache
                    attendanceDataCache = { values: data.values, range: currentRange };
                    return data.values;
                }
                
                const [headerRow, ...sellerRows] = dataValues;
                
                // Find the column index that matches the clicked date (Daily View)
                // Date strings in the header row are assumed to be in index >= 3 (Column D onwards)
                // Note: The structure expects First Name (Col 0), Last Name (Col 1), Designation (Col 2), then Dates (Col 3+)
                
                const dateHeaderIndex = headerRow.findIndex((cell, index) => {
                    if (index < 3) return false; // Skip first three columns (Name/Designation)
                    
                    // Normalize clicked date (9/4/2025)
                    const dateParts = dateString.split('/').map(p => p.startsWith('0') ? p.substring(1) : p);
                    const normalizedClickedDate = dateParts.join('/'); // 9/4/2025
                    
                    // Normalize spreadsheet cell date (Handle 9/4/2025, 09/04/2025, etc.)
                    // Check if cell is a valid date string before normalizing
                    const cellDate = new Date(cell);
                    let normalizedCell = '';
                    if (!isNaN(cellDate)) {
                        normalizedCell = cellDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
                    }
                    
                    // Check original cell, normalized cell, and dateString directly for robust matching
                    return normalizedClickedDate === normalizedCell || cell.trim() === dateString || cell.trim() === new Date(dateString).toLocaleDateString();
                });

                if (dateHeaderIndex === -1) {
                    modalBody.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è No column data found for **${dateString}** in sheet **${range.split('!')[0]}**. Please ensure the spreadsheet header dates match the **M/D/YYYY** format.</div>`;
                    return;
                }
                
                // --- 1. Daily Present Seller List & Summary ---
                let presentCount = 0;
                let presentSellers = [];
                let totalSellers = sellerRows.length;
                
                sellerRows.forEach(row => {
                    // Use index 0 and 1 for first and last name, assuming range starts at A7
                    const fullName = `${row[0] || ''} ${row[1] || ''}`.trim();
                    const rawStatus = (row[dateHeaderIndex] || '').trim().toUpperCase();
                    const status = rawStatus === '' ? 'ABSENT' : rawStatus;
                    
                    if (!fullName) return; 

                    // Check if seller is Present
                    const isPresent = status.includes('PRESENT') || status === 'P'; 
                    
                    // Check if seller is Absent
                    const isAbsent = status.includes('ABSENT') || status === 'A';
                    
                    if (isPresent) {
                        presentCount++;
                        presentSellers.push({ name: fullName, status: status, rowIndex: row.index });
                    } else {
                        // Count all other statuses (ABSENT, LATE, DAY OFF, etc.)
                        presentSellers.push({ name: fullName, status: status, rowIndex: row.index });
                    }
                });
                
                // FIX: The total absent/other count is now removed


                let htmlContent = `
                    <h4 class="gold-accent mb-3">Daily Summary: ${dateString}</h4>
                    <p class="text-center fw-bold text-lg text-white-75">
                        <span class="text-success me-3">PRESENT: ${presentCount}</span>
                    </p>
                    <hr class="border-secondary">
                `;

                // --- NEW: List of Sellers Present/Absent/Other Today ---
                if (presentSellers.length > 0) {
                    htmlContent += '<h5 class="gold-accent mt-4 mb-2">Sellers Status Today:</h5>';
                    htmlContent += '<ul class="present-seller-list list-group list-group-flush mb-4">';
                    
                    // Sort sellers by status (Present first, then Absent, then Other)
                    presentSellers.sort((a, b) => {
                        const statusA = (a.status || 'ABSENT').toUpperCase();
                        const statusB = (b.status || 'ABSENT').toUpperCase();
                        
                        // Sort Present first
                        if (statusA.includes('P') && !statusB.includes('P')) return -1;
                        if (!statusA.includes('P') && statusB.includes('P')) return 1;
                        
                        // Sort Absent next
                        if (statusA === 'ABSENT' && statusB !== 'ABSENT') return 1;
                        if (statusA !== 'ABSENT' && statusB === 'ABSENT') return -1;
                        
                        return a.name.localeCompare(b.name); // Sort by name otherwise
                    });

                    presentSellers.forEach(seller => {
                        const isAbsent = seller.status.includes('ABSENT') || seller.status === 'A';
                        
                        let statusIndicator = seller.status.length > 1 ? seller.status : (seller.status === 'P' ? 'PRESENT' : (seller.status === 'A' ? 'ABSENT' : seller.status));
                        
                        // FIX: Remove 'ABSENT' tag and leave it blank
                        if (isAbsent) {
                            statusIndicator = '';
                        }
                        
                        let statusColorClass = 'text-info'; // Default for OTHER
                        if (statusIndicator.includes('PRESENT') || statusIndicator === 'P') {
                             statusColorClass = 'text-success';
                        } else if (isAbsent) {
                             statusColorClass = 'text-danger';
                        }
                        
                        htmlContent += `<li class="list-group-item list-group-item-dark futuristic-card d-flex justify-content-between">
                                            <span class="fw-bold">${seller.name}</span>
                                            <span class="${statusColorClass}">${statusIndicator}</span>
                                        </li>`;
                    });
                    htmlContent += '</ul><hr class="border-secondary">';
                } else {
                    htmlContent += '<div class="alert alert-info">No seller status records found for this day.</div>';
                }
                
                if (totalSellers === 0) {
                    modalBody.innerHTML = '<div class="alert alert-warning">No seller records found in the spreadsheet range for this period.</div>';
                    return;
                }

                // --- 3. Full History Table for Present Sellers (Updated to include all tracked sellers) ---
                htmlContent += `
                    <h4 class="gold-accent mt-4 mb-3">Full Attendance History for All Tracked Sellers</h4>
                    <div class="table-responsive">
                    <table class="table table-dark table-bordered table-sm">
                        <thead>
                            <tr>
                                <th scope="col" class="text-center">Seller</th>
                `;

                // Add date headers (starting from index 3 in headerRow)
                const dateHeaders = headerRow.slice(3).filter(h => h.trim() !== '');

                dateHeaders.forEach(dateH => {
                    // Highlight the clicked date column
                    const isClickedDay = new Date(dateH).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) === new Date(dateString).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) ? 'table-warning text-dark fw-bold' : '';
                    htmlContent += `<th scope="col" class="attendance-cell ${isClickedDay}">${dateH.split('/')[1]}</th>`;
                });

                htmlContent += `</tr></thead><tbody>`;

                // Add ALL seller rows for history view
                sellerRows.forEach(sellerRow => {
                    const fullName = (`${sellerRow[0] || ''} ${sellerRow[1] || ''}`).trim();
                    if (!fullName) return; 

                    htmlContent += `<tr><td class="fw-bold">${fullName}</td>`;

                    // Add daily status cells (starting from index 3)
                    sellerRow.slice(3).forEach((statusCell, index) => {
                        const status = (statusCell || '').trim().toUpperCase();
                        // Get the correct date header index for the background coloring
                        const dateH = dateHeaders[index];
                        const isClickedDay = new Date(dateH).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) === new Date(dateString).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) ? 'table-warning' : '';
                        
                        let displayStatus = status.substring(0, 1) || 'A';
                        if (status === 'PRESENT' || status === 'P') {
                            displayStatus = 'P';
                        } else if (status === 'ABSENT' || status === '') {
                             displayStatus = 'A';
                        } else if (status.includes('LATE')) {
                            displayStatus = 'L';
                        } else if (status.includes('DAY OFF') || status === 'D') {
                            displayStatus = 'D';
                        } else if (status.length > 1) {
                            // Use first initial if status is complex (e.g., 'SICK', 'VACATION')
                            displayStatus = status.substring(0, 1);
                        }
                        
                        // Use a background color based on the status abbreviation
                        const statusClass = `status-${displayStatus}`;
                        htmlContent += `<td class="attendance-cell ${statusClass} ${isClickedDay}">${displayStatus}</td>`;
                    });

                    htmlContent += `</tr>`;
                });

                htmlContent += `</tbody></table></div>`;
                
                modalBody.innerHTML = htmlContent;

            } catch (error) {
                modalBody.innerHTML = `<div class="alert alert-danger">‚ùå Failed to load attendance. Error: ${error.message}</div>`;
                console.error(`Error loading attendance for ${dateString}:`, error);
            }
        }


        // --- View Switching Logic (for single-page navigation) ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Determine the target view ID
            let targetId;
            if (viewId === 'home') {
                targetId = 'home-view';
            } else {
                targetId = `${viewId}-view`;
            }

            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.style.display = 'block';
                
                // FIX: If the Mandays view is loaded, render the calendar immediately.
                if (viewId === 'mandays') {
                    // Check if the target content area exists before rendering
                    const calendarContentArea = document.getElementById('seller-content');
                    if (calendarContentArea) {
                        // We call renderAttendanceCalendar directly, bypassing the collapsed listener, 
                        // which ensures it loads even if the element state is initially tricky.
                        renderAttendanceCalendar('seller-content', currentCalendarDate);
                    }
                }
            }
        }

        // --- Bootstrap Collapse Event Listeners for Dynamic Data Loading ---
        // Listener function helper
        function setupCollapseListener(contentId, range, config = {}) {
            const element = document.getElementById(contentId);
            if (!element) {
                // console.warn(`Element with ID ${contentId} not found. Skipping listener setup.`);
                return; // Safely exit if the element is null
            }

            element.addEventListener('show.bs.collapse', function () {
                // Check if content already exists to prevent repeated API calls/rendering
                if (this.querySelector('.table-responsive') === null && this.querySelector('.chart-container') === null && config.type !== 'calendar') {
                    if (config.type === 'chart') {
                        // For chart rendering, call the specific chart function
                        fetchAndRenderChart(
                            SPREADSHEET_ID,
                            range,
                            config.canvasId,
                            config
                        );
                    } else {
                        // For table rendering, call the standard fetch function
                        fetchAndRender(
                            SPREADSHEET_ID,
                            range,
                            contentId,
                            config.customHeaders
                        );
                    }
                } else if (config.type === 'calendar') {
                     // The calendar is now rendered by switchView, so this block is mostly for completeness.
                    // renderAttendanceCalendar(contentId, currentCalendarDate); 
                }
                 // NEW: Call the list renderer specifically for the attendance list
                if (config.type === 'attendance_list') {
                     renderAttendanceListPerSeller(contentId);
                }
            });
            // Cleanup on hide
            element.addEventListener('hide.bs.collapse', function () {
                if (config.type === 'chart' && chartInstances[config.canvasId]) {
                    chartInstances[config.canvasId].destroy();
                    delete chartInstances[config.canvasId];
                }
            });
        }

        function initializeListeners() {
            // 1. MANDAYS REPORTS
            // We keep the listener here, but the primary rendering is now in switchView for reliability.
            setupCollapseListener('seller-content', '', { type: 'calendar' }); 

            // New Chart Listener: Attendance Per Seller Chart
            // FIX: The type is changed from 'chart' to 'attendance_list' and the canvas ID is removed.
            setupCollapseListener('attendance-seller-chart-content', '', {
                type: 'attendance_list',
                // canvasId is no longer needed
            });

            // 2. POSTPAID REPORTS
            setupCollapseListener('postpaid-submitted-content', 'Sheet2!U16:W16', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITED: Custom Headers and Data-Only Range
            setupCollapseListener('postpaid-approved-content', 'Sheet2!U17:W17', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: Applications Approved Range
            setupCollapseListener('postpaid-denied-content', 'Sheet2!U21:W21', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: Applications Denied Range
            setupCollapseListener('postpaid-installed-content', 'Sheet2!U18:W18', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: Applications Installed Range
            setupCollapseListener('postpaid-forinstall-content', 'Sheet2!U19:W19', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: Applications for Installation Range
            setupCollapseListener('postpaid-forapproval-content', 'Sheet2!U20:W20', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: Applications for Approval T
            // ... (rest of the listeners are wrapped in initializeListeners and are correct for their respective containers) ...


            // 3. WOWFI PRO PREPAID REPORTS
            // FIX: These elements exist within the collapsed wowfipro-view, but their immediate parent elements do not exist yet when the script first runs.
            // However, since they are children of wowfipro-view, we check if the view is available before accessing the child elements.
            const wowFiView = document.getElementById('wowfipro-view');
            if (wowFiView) {
                // If the container exists, we assume the children exist or will be accessed safely when expanded.
                setupCollapseListener('wowfi-sold-content', 'WowFi_Sold_Count!A1:B1'); // EDITABLE: No. of Sold Range
                setupCollapseListener('wowfi-activated-content', 'WowFi_Activated_Count!A1:B1'); // EDITABLE: No. of Activated Range
                setupCollapseListener('wowfi-daily-chart-content', 'WowFi_Daily_Chart!A1:C10'); // EDITABLE: Daily Chart Data Range
                setupCollapseListener('wowfi-seller-chart-content', 'WowFi_Seller_Chart!A1:C10'); // EDITABLE: Seller Chart Data Range
            }


            // 4. SIM SOLD REPORTS
             const simSoldView = document.getElementById('simsold-view');
             if (simSoldView) {
                setupCollapseListener('simsold-sold-content', 'Sheet2!U24:W24', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: No. of Sold Range
                setupCollapseListener('simsold-activated-content', 'Sheet2!U25:W25', {customHeaders: ['Total', 'Target', 'Achievement']}); // EDITABLE: No. of Activated Range
                
                // --- SIM Sold Charts ---
                // 4A. Visual Chart for Sold per Day (Line Chart for Time Series Data)
                setupCollapseListener('simsold-daily-chart-content', 'FSF Monitoring/Report!C3:AI17', { 
                    type: 'chart', 
                    canvasId: 'simSoldDailyChart', 
                    chartTitle: 'SIM Sold Performance per Day (Total Sales)', 
                    dataLabel: 'Sold Units', 
                    chartType: 'line',
                    processingMode: 'daily_total' // New mode for column sums
                }); 
                
                // 4B. Visual Chart for Total Sold per Seller (Bar Chart for Categorical Data)
                setupCollapseListener('simsold-seller-total-chart-content', 'FSF Monitoring/Report!C3:AI17', { 
                    type: 'chart', 
                    canvasId: 'simSoldSellerTotalChart', 
                    chartTitle: 'Total SIM Sold per Seller (All Dates)', 
                    dataLabel: 'Total Sold Units', 
                    chartType: 'bar',
                    processingMode: 'seller_total' // New mode for row sums
                });

                // 4C. Visual Chart for Activated per Seller (Original Block)
                setupCollapseListener('simsold-seller-chart-content', 'Sheet2!D1:E10', { 
                    type: 'chart', 
                    canvasId: 'simSoldSellerChart', 
                    chartTitle: 'SIM Activated Performance per Seller', 
                    dataLabel: 'Activated Units', 
                    chartType: 'bar' 
                });
            }
        }


        // Initialize all listeners after the entire HTML structure is loaded.
        document.addEventListener('DOMContentLoaded', () => {
            initializeListeners();
            switchView('home'); // Load the new grid view first
        });
    </script>
</body>
</html>
